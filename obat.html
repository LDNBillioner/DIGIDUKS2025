<!-- obat.html (versi sederhana) -->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UKS | Manajemen Obat (In/Out)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .table-fixed { max-height: 480px; overflow:auto; display:block; }
    .table-fixed table { width:100%; }
    .small-muted { font-size:0.9rem; color:#6c757d; }
    .badge-in { background:#198754; }
    .badge-out { background:#dc3545; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">
    <a class="navbar-brand" href="index.html">DIGIDUKS</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMain">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="cari.html">Cari Siswa</a></li>
        <li class="nav-item"><a class="nav-link active" href="obat.html">Obat</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-end mb-3">
    <div>
      <h3>Manajemen Obat — In / Out</h3>
      <div class="small-muted">Sumber: Google Sheets (CSV)</div>
    </div>

    <div style="min-width:320px;">
      <div class="input-group">
        <input id="searchInput" class="form-control" placeholder="Cari nama obat..." />
        <button class="btn btn-outline-secondary" id="btnReload">Reload</button>
      </div>
      <div class="form-text small-muted">Klik Reload untuk ambil data terbaru.</div>
    </div>
  </div>

  <div id="status" class="mb-3"></div>

  <div class="card">
    <div class="card-header">Tabel Obat</div>
    <div class="card-body p-2">
      <div class="table-fixed">
        <table class="table table-striped table-hover mb-0" id="tabelObat">
          <thead class="table-light">
            <tr>
              <th style="min-width:180px">Nama Obat</th>
              <th style="min-width:100px">Jumlah</th>
              <th style="min-width:100px">Status</th>
            </tr>
          </thead>
          <tbody id="tabelBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const urlCsv = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQVeFi-DptKvuUe-M8A3XU8fg_DF_iwLCem9Z0WWgbOBEtGKUiwwacqJiZF7JYJE6lhWuOCq2a1sK4M/pub?gid=392002619&single=true&output=csv';

function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/).filter(l => l.trim() !== '');
  const headers = lines[0].split(',').map(h => h.trim());
  const rows = lines.slice(1).map(line => {
    const cols = line.split(',').map(c => c.trim());
    const obj = {};
    headers.forEach((h,i) => obj[h] = cols[i] || '');
    return obj;
  });
  return { headers, rows };
}

function findColName(headers, candidates) {
  const low = headers.map(h => h.toLowerCase());
  for (const c of candidates) {
    const idx = low.findIndex(h => h.includes(c.toLowerCase()));
    if (idx !== -1) return headers[idx];
  }
  return null;
}

function parseNumber(val) {
  const n = parseFloat((val || '').replace(/[^\d.,-]/g,'').replace(',','.'));
  return isNaN(n) ? 0 : n;
}

function parseDate(val) {
  if (!val) return null;
  const parts = val.split(/[\/\-]/);
  if (parts.length === 3) {
    let [d,m,y] = parts.map(p => parseInt(p));
    if (y < 100) y += 2000;
    if (m > 12) [d,m] = [m,d]; // fallback jika formatnya kebalik
    return new Date(y, m - 1, d);
  }
  const t = Date.parse(val);
  return isNaN(t) ? null : new Date(t);
}

const statusEl = document.getElementById('status');
const tabelBody = document.getElementById('tabelBody');
const searchInput = document.getElementById('searchInput');
const btnReload = document.getElementById('btnReload');

btnReload.addEventListener('click', loadData);
searchInput.addEventListener('input', renderTable);

let obatData = [];

async function loadData() {
  statusEl.innerHTML = `<div class="alert alert-info">Memuat data dari spreadsheet...</div>`;
  try {
    const resp = await fetch(urlCsv);
    if (!resp.ok) throw new Error('Gagal memuat CSV');
    const text = await resp.text();
    const { headers, rows } = parseCSV(text);

    const colNama = findColName(headers, ['nama', 'obat', 'nama obat']);
    const colJumlah = findColName(headers, ['jumlah', 'qty', 'stok']);
    const colStatus = findColName(headers, ['status', 'in/out', 'inout']);
    const colTanggal = findColName(headers, ['tanggal', 'date', 'waktu']);

    // ambil semua tanggal valid
    const tanggalList = rows
      .map(r => parseDate(r[colTanggal]))
      .filter(d => d instanceof Date && !isNaN(d));

    const latestDate = tanggalList.length
      ? new Date(Math.max(...tanggalList))
      : null;

    const map = {};
    rows.forEach(r => {
      const nama = r[colNama] || '';
      if (!nama) return;

      const tgl = parseDate(r[colTanggal]);
      if (latestDate && (!tgl || tgl.toDateString() !== latestDate.toDateString())) return; // hanya ambil tanggal terbaru

      const jumlah = parseNumber(r[colJumlah]);
      const status = (r[colStatus] || '').trim().toUpperCase();

      if (!map[nama]) {
        map[nama] = { nama, jumlah, status, tanggal: tgl };
      } else {
        if (status === 'IN') map[nama].jumlah += jumlah;
        else if (status === 'OUT') map[nama].jumlah -= jumlah;
      }
    });

    obatData = Object.values(map);
    const dateInfo = latestDate ? latestDate.toLocaleDateString('id-ID') : '—';
    statusEl.innerHTML = `<div class="alert alert-success">Data tanggal terbaru: <strong>${dateInfo}</strong> (${obatData.length} item).</div>`;
    renderTable();
  } catch (err) {
    console.error(err);
    statusEl.innerHTML = `<div class="alert alert-danger">Terjadi kesalahan: ${err.message}</div>`;
  }
}

function renderTable() {
  const q = searchInput.value.trim().toLowerCase();
  const filtered = obatData.filter(o => o.nama.toLowerCase().includes(q));

  tabelBody.innerHTML = '';
  if (filtered.length === 0) {
    tabelBody.innerHTML = `<tr><td colspan="3" class="text-center">Tidak ada data.</td></tr>`;
    return;
  }

  filtered.forEach(o => {
    const badge = o.status === 'IN'
      ? `<span class="badge badge-in">IN</span>`
      : `<span class="badge badge-out">OUT</span>`;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${o.nama}</strong></td>
      <td>${o.jumlah}</td>
      <td>${badge}</td>
    `;
    tabelBody.appendChild(tr);
  });
}

document.addEventListener('DOMContentLoaded', loadData);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>